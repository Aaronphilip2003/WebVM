name: Deploy to WebVM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Install Tailscale
      run: |
        sudo apt-get update
        sudo apt-get install -y curl
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscaled &
        sudo tailscale up --auth-key=tskey-auth-kgS2dM8Fy511CNTRL-KSXRVhvzAp8A46Grihhho83zoyi15RZe --hostname=webvm-deployer

    - name: Build Docker image
      run: |
        docker build -t fastapi-app:latest .
        docker save fastapi-app:latest > fastapi-app.tar

    - name: Deploy to WebVM
      run: |
        scp fastapi-app.tar user@100.111.221.90:~/fastapi-app.tar
        ssh user@100.111.221.90 << 'EOF'
          docker load < ~/fastapi-app.tar
          docker run -d -p 8000:8000 fastapi-app:latest
        EOF
